<!DOCTYPE html>
<html>

<head>
    <style>
        .rowbox {
            display: flex;
            flex-direction: row;
        }

        .columnbox {
            display: flex;
            flex-direction: column;
        }
    </style>
    <base target="_top">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>

<body>
    <div id=alarm></div>
    <div id="timer_display" style="font-size: 32px; font-weight: bold; color: red;">05:00</div>
    <button id="reset_button" type="button" onclick="reset()">初期化</button>
    <button id="timer_button" type="button" onclick="startTimer()">タイマー:オン/オフ</button>
    <button type="button" onclick="openExplain()">使い方説明</button>
    <button type="button" onclick="openNameModal()">名前変更</button>
    <button type="button" onclick="openSettings()">設定</button>
    <button id="csv_register_button" type="button" class="button" onclick="csv_register()">CSV出力</button>
    <button id="undo_button" type="button" class="button" onclick="undo()">取り消し</button>
    <dialog id="settingsModal">
        <h3>設定</h3>
        <label>
            プレイヤー人数:
            <select id="player_count_select" onchange="changePlayerCount()">
                <option value="1">1人</option>
                <option value="2">2人</option>
                <option value="3">3人</option>
                <option value="4">4人</option>
                <option value="5">5人</option>
                <option value="6" selected>6人</option>
            </select>
        </label>
        <br><br>
        <button onclick="closeSettings()">閉じる</button>
    </dialog>
    <dialog id="nameModal">
        <h3>プレイヤーを選択してください</h3>
        <div class="rowbox" id="modal_player_container">
            <div class="columnbox">
                プレイヤー1
                <select name="player" id="player_select1">
                    <option value="----">----</option>
                    <option value="a">a</option>
                    <option value="b">b</option>
                    <option value="c">c</option>
                </select>
            </div>
            <div class="columnbox">
                プレイヤー2
                <select name="player" id="player_select2">
                    <option value="----">----</option>
                    <option value="a">a</option>
                    <option value="b">b</option>
                    <option value="c">c</option>
                </select>
            </div>
            <div class="columnbox">
                プレイヤー3
                <select name="player" id="player_select3">
                    <option value="----">----</option>
                    <option value="a">a</option>
                    <option value="b">b</option>
                    <option value="c">c</option>
                </select>
            </div>
            <div class="columnbox">
                プレイヤー4
                <select name="player" id="player_select4">
                    <option value="----">----</option>
                    <option value="a">a</option>
                    <option value="b">b</option>
                    <option value="c">c</option>
                </select>
            </div>
            <div class="columnbox">
                プレイヤー5
                <select name="player" id="player_select5">
                    <option value="----">----</option>
                    <option value="a">a</option>
                    <option value="b">b</option>
                    <option value="c">c</option>
                </select>
            </div>
            <div class="columnbox">
                プレイヤー6
                <select name="player" id="player_select6">
                    <option value="----">----</option>
                    <option value="a">a</option>
                    <option value="b">b</option>
                    <option value="c">c</option>
                </select>
            </div>
        </div>
        <br>
        <button onclick="selectName()">保存</button>
        <button onclick="closeNameModal()">閉じる</button>
    </dialog>
    <dialog id="explain">
        説明
        <br>
        <button onclick="closeExplain()">閉じる</button>
    </dialog>
    <div id=pon1></div>
    <div id=pon2></div>
    <div id=pon3></div>
    <div id=pon4></div>
    <div id="display"></div>
    <div class="rowbox" id="main_player_container">
        <div class="columnbox">
            <div id="sum_score1">0</div>
            <div id="player_name1">----</div>
            <button id="register_button" type="button" class="button" onclick="point_register(1)">登録</button>
        </div>
        <div class="columnbox">
            <div id="sum_score2">0</div>
            <div id="player_name2">----</div>
            <button id="register_button" type="button" class="button" onclick="point_register(2)">登録</button>
        </div>
        <div class="columnbox">
            <div id="sum_score3">0</div>
            <div id="player_name3">----</div>
            <button id="register_button" type="button" class="button" onclick="point_register(3)">登録</button>
        </div>
        <div class="columnbox">
            <div id="sum_score4">0</div>
            <div id="player_name4">----</div>
            <button id="register_button" type="button" class="button" onclick="point_register(4)">登録</button>
        </div>
        <div class="columnbox">
            <div id="sum_score5">0</div>
            <div id="player_name5">----</div>
            <button id="register_button" type="button" class="button" onclick="point_register(5)">登録</button>
        </div>
        <div class="columnbox">
            <div id="sum_score6">0</div>
            <div id="player_name6">----</div>
            <button id="register_button" type="button" class="button" onclick="point_register(6)">登録</button>
        </div>
    </div>
    <script>
        let data = ["", "", "", ""];
        let displayElement = document.getElementById('display');
        let alarmElement = document.getElementById('alarm');
        let firebaseConfig = {
            apiKey: "AIzaSyC9Q0Nuo6EsoWmDFaMFm5zLs2d-e4JgC2A",
            databaseURL: "https://kousoku-6477e-default-rtdb.firebaseio.com",
            projectId: "kousoku-6477e"
        };
        let db
        let timeLeft = 300
        let TimerRunning = false
        let TimerInterval
        let lastAction = { playerNum: null, score: 0 }; // 最後に操作したプレイヤー番号とスコア
        let maxPlayers = 6; // 現在の最大プレイヤー数
        function initializeFirebase() {
            if (typeof firebase !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                const calculateAndShow = () => {
                    if (data.every(val => val)) {
                        score = data.reduce((a, b) => Number(a) * Number(b));
                        displayElement.innerText = score;
                    }
                };
                const pon = (judge_num) => {
                    let ponElement = document.getElementById('pon' + judge_num);
                    ponElement.innerText = "A";
                }
                db.ref('shared_value1').on('value', (snapshot) => {
                    data[0] = snapshot.val()
                    if (data[0]) {
                        pon(1);
                        calculateAndShow();
                    }
                });
                db.ref('shared_value2').on('value', (snapshot) => {
                    data[1] = snapshot.val()
                    if (data[1]) {
                        pon(2);
                        calculateAndShow();
                    }
                });
                db.ref('shared_value3').on('value', (snapshot) => {
                    data[2] = snapshot.val()
                    if (data[2]) {
                        pon(3);
                        calculateAndShow();
                    }
                });
                db.ref('shared_value4').on('value', (snapshot) => {
                    data[3] = snapshot.val()
                    if (data[3]) {
                        pon(4);
                        calculateAndShow();
                    }
                });
            }
            else {
                // まだ読み込まれていなければ0.1秒後に再試行
                setTimeout(initializeFirebase, 100);
            }
        }
        function point_register(player_number) {
            if (data.every(val => val)) {
                time = new Date
                hour = time.getHours();
                min = time.getMinutes();
                timestanp = String(hour).padStart(2, '0') + ":" + String(min).padStart(2, '0')
                const id = "player_select" + player_number
                const selectElement = document.getElementById(id);
                selected_player = selectElement.value
                score = data.reduce((a, b) => Number(a) * Number(b));
                const sum_scoreElement = document.getElementById('sum_score' + player_number);
                sum_score = Number(score) + Number(sum_scoreElement.innerText)
                sum_scoreElement.innerText = sum_score;
                result = [timestanp, selected_player, score, "合計:" + sum_score, "審査点:"].concat(data)
                google.script.run.saveData(result);
                lastAction.playerNum = player_number;
                lastAction.score = score;
                displayElement.innerText = "";
                data = ["", "", "", ""];
                for (let i = 1; i < 5; i++) {
                    ponElement = document.getElementById('pon' + i);
                    ponElement.innerText = ""
                }
                for (let i = 1; i < 5; i++) {
                    db.ref("shared_value" + i).set("")
                }
            }
            else {
                alarmElement.innerText = "採点が終わってないよ";
                setTimeout(() => {
                    alarmElement.innerText = "";
                }, 1000);
            }
        }
        function undo() {
            if (data.some(val => val !== "")) {
                data = ["", "", "", ""];
                score = "";
                displayElement.innerText = "";
                for (let i = 1; i < 5; i++) {
                    ponElement = document.getElementById('pon' + i);
                    ponElement.innerText = ""
                }
                for (let i = 1; i < 5; i++) {
                    db.ref("shared_value" + i).set("")
                }
            }
            else {
                if (lastAction.playerNum === null) {
                    alert("取り消せる操作がありません。");
                    return;
                }
                if (confirm("直前の登録を取り消しますか？")) {
                    // 1. 画面上の合計点を引き算して戻す
                    const targetScoreElement = document.getElementById('sum_score' + lastAction.playerNum);
                    let currentSum = Number(targetScoreElement.innerText);
                    targetScoreElement.innerText = currentSum - lastAction.score;
                    // 2. GAS（スプレッドシート）の最新行を消す
                    google.script.run.undoLastRow();
                    // 3. 履歴を空にする（2回連続で消せないようにする）
                    lastAction.playerNum = null;
                    lastAction.score = 0;
                    alert("取り消しました。");
                }
            }
            displayElement.innerText = "";
            google.script.run.saveData(["undoしました"]);
        }
        const nameModal = document.getElementById('nameModal');
        const settingsModal = document.getElementById('settingsModal');
        function openSettings() {
            settingsModal.showModal();
        }
        function closeSettings() {
            settingsModal.close();
        }
        function changePlayerCount() {
            const select = document.getElementById('player_count_select');
            maxPlayers = parseInt(select.value, 10);
            // UIの表示切り替え（メイン画面）
            const mainContainer = document.getElementById('main_player_container');
            // columnboxクラスを持つ要素をすべて取得（プレイヤーごとの列）
            // 注意: html構造上、main_player_containerの直下にcolumnboxが並んでいる前提
            // 現状のHTML構造に合わせて、子要素のdiv.columnboxを取得します
            const mainPlayerDivs = mainContainer.querySelectorAll(':scope > .columnbox');
            mainPlayerDivs.forEach((div, index) => {
                if (index < maxPlayers) {
                    div.style.display = 'flex';
                } else {
                    div.style.display = 'none';
                }
            });
            // UIの表示切り替え（名前選択モーダル）
            const modalContainer = document.getElementById('modal_player_container');
            const modalPlayerDivs = modalContainer.querySelectorAll(':scope > .columnbox');
            modalPlayerDivs.forEach((div, index) => {
                if (index < maxPlayers) {
                    div.style.display = 'flex';
                } else {
                    div.style.display = 'none';
                }
            });
            // 設定変更時にリセット（整合性を保つため）
            if (confirm("プレイヤー人数を変更しました。スコアをリセットしますか？")) {
                reset();
            }
        }
        function openNameModal() {
            nameModal.showModal(); // showModal()を使うと背景がクリック不可になります
        }
        function selectName() {
            for (i = 1; i <= maxPlayers; i++) {
                document.getElementById("player_name" + i).innerText = document.getElementById("player_select" + i).value
            }
            nameModal.close(); // ウィンドウを閉じる
        }
        function closeNameModal() {
            nameModal.close();
        }
        function csv_register() {
            playername_csv = []
            score_csv = []
            for (i = 0; i < maxPlayers; i++) {
                playername_csv.push(document.getElementById("player_name" + (i + 1)).innerText)
                score_csv.push(document.getElementById("sum_score" + (i + 1)).innerText)
            }
            // 配列の長さを揃える必要がない（GAS側で対応済み）ならこれでおくる
            // もしCSVの列数を固定したいなら適宜空文字埋めが必要だが、
            // 今回は可変長に対応したのでそのまま送る
            csv = [playername_csv, score_csv]
            google.script.run.saveCsv(csv);
        }
        const explain = document.getElementById('explain');
        function openExplain() {
            explain.showModal(); // showModal()を使うと背景がクリック不可になります
        }
        function closeExplain() {
            explain.close();
        }
        function startTimer() {
            const btn = document.getElementById('timer_button');
            if (!TimerRunning) {
                TimerRunning = true
                btn.innerText = "タイマーオフ";
                TimerInterval = setInterval(
                    () => {
                        timeLeft--;
                        const minute = Math.floor(timeLeft / 60);
                        const second = timeLeft % 60;
                        const display =
                            String(minute).padStart(2, '0') + ":" +
                            String(second).padStart(2, '0');
                        document.getElementById('timer_display').innerText = display;
                    }
                    , 1000
                )
            }
            else {
                TimerRunning = false
                clearInterval(TimerInterval)
                btn.innerText = "タイマーオン";
            }
        }
        function reset() {
            // リセット時も現在のプレイヤー数だけ記録するか、全クリアするか。
            // ここでは現在の表示設定に基づいてCSV保存してからリセットする
            playername_csv = []
            score_csv = []
            for (i = 0; i < maxPlayers; i++) {
                playername_csv.push(document.getElementById("player_name" + (i + 1)).innerText)
                score_csv.push(document.getElementById("sum_score" + (i + 1)).innerText)
            }
            csv = [playername_csv, score_csv]
            google.script.run.saveCsv(csv);
            displayElement.innerText = "";
            for (let i = 1; i < 5; i++) {
                ponElement = document.getElementById('pon' + i);
                ponElement.innerText = ""
                db.ref("shared_value" + i).set("")
            }
            // 全プレイヤー要素（非表示含む）のスコアを0に戻しておくのが安全
            for (let i = 1; i < 7; i++) {
                sum_scoreElement = document.getElementById('sum_score' + i);
                if (sum_scoreElement) sum_scoreElement.innerText = 0;
            }
            data = ["", "", "", ""];
        }
        // 実行開始
        initializeFirebase();
    </script>
</body>

</html>